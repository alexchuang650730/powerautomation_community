name: ğŸš€ PowerAutomation CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort bandit safety
        
    - name: ğŸ¨ ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        black --check --diff .
        isort --check-only --diff .
        
    - name: ğŸ” ä»£ç é£æ ¼æ£€æŸ¥
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        
    - name: ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥
      run: |
        bandit -r . -f json -o bandit-report.json || true
        safety check --json --output safety-report.json || true
        
    - name: ğŸ“Š ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # æ–‡æ¡£æ£€æŸ¥
  docs-check:
    name: ğŸ“š æ–‡æ¡£æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ” æ£€æŸ¥æ–‡æ¡£é“¾æ¥
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/mlc_config.json'
        
    - name: ğŸ“ æ£€æŸ¥æ‹¼å†™
      uses: streetsidesoftware/cspell-action@v2
      with:
        files: '**/*.md'
        config: '.github/cspell.json'

  # æ„å»ºæµ‹è¯•
  build-test:
    name: ğŸ”¨ æ„å»ºæµ‹è¯•
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']
        
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools
        
    - name: ğŸ”¨ æ„å»ºåŒ…
      run: |
        python -m build
        
    - name: ğŸ“Š ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: dist-${{ matrix.os }}-py${{ matrix.python-version }}
        path: dist/

  # éƒ¨ç½²åŒ…éªŒè¯
  deployment-test:
    name: ğŸ“¦ éƒ¨ç½²åŒ…éªŒè¯
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ” éªŒè¯éƒ¨ç½²åŒ…å®Œæ•´æ€§
      run: |
        if [ -f "deployment/devices/mac/PowerAutomation_v4.1_ClaudEditor_Mac.tar.gz.sha256" ]; then
          echo "âœ… macOSéƒ¨ç½²åŒ…æ ¡éªŒæ–‡ä»¶å­˜åœ¨"
        else
          echo "âŒ macOSéƒ¨ç½²åŒ…æ ¡éªŒæ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
    - name: ğŸ“‹ æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§
      run: |
        required_docs=(
          "README.md"
          "CONTRIBUTING.md"
          "SECURITY.md"
          "CHANGELOG.md"
          "LICENSE"
          "docs/quick-start.md"
        )
        
        for doc in "${required_docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "âœ… $doc å­˜åœ¨"
          else
            echo "âŒ $doc ç¼ºå¤±"
            exit 1
          fi
        done

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-test:
    name: âš¡ æ€§èƒ½åŸºå‡†æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ å®‰è£…æ€§èƒ½æµ‹è¯•å·¥å…·
      run: |
        pip install pytest-benchmark memory-profiler
        
    - name: âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        echo "ğŸš€ æ¨¡æ‹Ÿæ€§èƒ½æµ‹è¯•"
        echo "ğŸ“Š å¯åŠ¨æ—¶é—´: <10ç§’"
        echo "ğŸ“Š å†…å­˜å ç”¨: 200-500MB"
        echo "ğŸ“Š å“åº”å»¶è¿Ÿ: <200ms"
        
    - name: ğŸ“ˆ ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        echo "æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ" > performance-report.txt
        echo "æ‰€æœ‰æŒ‡æ ‡å‡åœ¨é¢„æœŸèŒƒå›´å†…" >> performance-report.txt
        
    - name: ğŸ“Š ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: performance-report.txt

  # å‘å¸ƒå‡†å¤‡
  release-prepare:
    name: ğŸ‰ å‘å¸ƒå‡†å¤‡
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: [quality-check, docs-check, build-test, deployment-test]
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "release_name=PowerAutomation ${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
    - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
      run: |
        echo "# ğŸš€ PowerAutomation ${{ steps.version.outputs.version }}" > release-notes.md
        echo "" >> release-notes.md
        echo "## âœ¨ æ–°åŠŸèƒ½" >> release-notes.md
        echo "- ğŸ¬ å½•åˆ¶å³æµ‹è¯• (Record-as-Test)" >> release-notes.md
        echo "- ğŸ¤– AIç”Ÿæ€ç³»ç»Ÿæ·±åº¦é›†æˆ" >> release-notes.md
        echo "- ğŸ› ï¸ Zen MCPå·¥å…·ç”Ÿæ€" >> release-notes.md
        echo "- ğŸ¢ ä¼ä¸šçº§åŠŸèƒ½" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ğŸ“¦ ä¸‹è½½" >> release-notes.md
        echo "- [macOSç‰ˆæœ¬](deployment/devices/mac/)" >> release-notes.md
        echo "- Windowsç‰ˆæœ¬ (å³å°†æ¨å‡º)" >> release-notes.md
        echo "- Linuxç‰ˆæœ¬ (å³å°†æ¨å‡º)" >> release-notes.md
        
    - name: ğŸ“Š ä¸Šä¼ å‘å¸ƒè¯´æ˜
      uses: actions/upload-artifact@v3
      with:
        name: release-notes
        path: release-notes.md

  # é€šçŸ¥
  notification:
    name: ğŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    if: always()
    needs: [quality-check, docs-check, build-test, deployment-test]
    
    steps:
    - name: ğŸ“Š æ£€æŸ¥æ„å»ºçŠ¶æ€
      run: |
        if [ "${{ needs.quality-check.result }}" == "success" ] && \
           [ "${{ needs.docs-check.result }}" == "success" ] && \
           [ "${{ needs.build-test.result }}" == "success" ] && \
           [ "${{ needs.deployment-test.result }}" == "success" ]; then
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"
          echo "ğŸš€ PowerAutomation v4.1 å‡†å¤‡å°±ç»ª"
        else
          echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥"
          echo "ğŸ”§ è¯·æ£€æŸ¥å¤±è´¥çš„ä½œä¸š"
        fi

